# NLP Embedding æžç®€åŒå¡”æ¨¡åž‹: ä»Ž 0 åˆ° 1 å­¦ä¹ æŒ‡å—

## ðŸŒŸ èƒŒæ™¯ä¸Žç›®æ ‡
ä¸ºäº†å¸®åŠ©åˆå­¦è€…ç›´è§‚ç†è§£è‡ªç„¶è¯­è¨€å¤„ç† (NLP) ä¸­çš„ Embeddingï¼ˆè¯åµŒå…¥ï¼‰æ¦‚å¿µåŠå…¶å®žçŽ°åŽŸç†ï¼Œæˆ‘ä»¬å‰¥ç¦»äº†ç¹æ‚çš„æ¡†æž¶å’Œæµ·é‡çš„é¢„è®­ç»ƒæ•°æ®ï¼Œä»Žé›¶å¼€å§‹æ­å»ºäº†ä¸€ä¸ªæžç®€çš„â€œåŒå¡”æ¨¡åž‹â€ã€‚
è¿™ä¸ªé¡¹ç›®çš„é‡ç‚¹åœ¨äºŽ**å¯è§†åŒ–ä¸Žäº¤äº’**ï¼šæˆ‘ä»¬ä¸è¿½æ±‚æœ€ä¼˜çš„ä¸šåŠ¡æ€§èƒ½ï¼Œè€Œæ˜¯é€šè¿‡ Streamlit å°†æ¨¡åž‹è®­ç»ƒçš„åŠ¨æ€è¿‡ç¨‹ï¼ˆLoss ä¸‹é™ï¼‰ã€é«˜ç»´ç‰¹å¾æ˜ å°„è¿‡ç¨‹ï¼ˆPCA äºŒç»´å¯è§†ï¼‰å’ŒæŽ¨ç†åˆ¤æ–­è¡¨çŽ°å¾—æ·‹æ¼“å°½è‡´ã€‚

## ðŸ§  æ ¸å¿ƒå®žçŽ°é€»è¾‘ä¸Žè®¾è®¡æ€è€ƒ

### 1. æ•°æ®é›† (Dataset & Tokenization)
- **æ•°æ®**ï¼šä½¿ç”¨ç»å…¸çš„å¼€æºä¸­æ–‡ç›¸ä¼¼åº¦æ•°æ®é›†ï¼ˆLCQMCï¼‰çš„ä¸€ä¸ªå¾®åž‹å­é›† `lcqmc_mini.csv`ï¼ˆåŒ…å« 60 æ¡å…¸åž‹çš„ç›¸ä¼¼/ä¸ç›¸ä¼¼é—®ç­”æ ·æœ¬ï¼‰ã€‚
- **åˆ†è¯å™¨ï¼ˆTokenizerï¼‰**ï¼šæ‰‹å†™äº†ä¸€ä¸ªæžä¸ºç®€å•çš„ `SimpleCharTokenizer`ã€‚å®ƒé€šè¿‡ä¸€æ¬¡éåŽ†å»ºç«‹åŸºäºŽå­— (Char-Level) çš„è¯æ±‡è¡¨ï¼Œå¹¶åœ¨æŽ¨æ–­æ—¶å¤„ç†å¡«å…… (Padding) é€»è¾‘ï¼Œå±•çŽ°â€œå­—åˆ° ID å‘é‡â€çš„æ ¸å¿ƒæœ¬è´¨ã€‚
- **æ‰“åŒ…**ï¼šå€ŸåŠ© PyTorch æ ‡å‡†çš„ `Dataset` å’Œ `DataLoader` é…ç½®ï¼Œä½“çŽ°ç»å…¸æ·±åº¦å­¦ä¹ å·¥ç¨‹è§„èŒƒã€‚

### 2. åŒå¡”æ¨¡åž‹ (Dual-Encoder Architecture)
- **æžç®€ç»“æž„**ï¼šæ¨¡åž‹ `SimpleDualEncoder` ä»…åŒ…å«ä¸€å±‚åŸºç¡€çš„ `nn.Embedding`ï¼Œå®ƒå°†ç¦»æ•£æ–‡å­—è½¬åŒ–ä¸ºè¿žç»­ç¨ å¯†å‘é‡ã€‚é€šè¿‡æŽ©ç ï¼ˆMaskï¼‰æœºåˆ¶æ¶ˆé™¤äº†å¡«å…… 0 ID çš„å½±å“ã€‚
- **æ± åŒ–ï¼ˆPoolingï¼‰**ï¼šé‡‡ç”¨åŸºç¡€æ— å‚æ•°çš„å¹³å‡æ± åŒ–ï¼ˆMean Poolingï¼‰ï¼ŒæŠŠä¸å®šé•¿çš„å­—ç¬¦çº§åºåˆ—ç‰¹å¾æµ“ç¼©æˆäº†å•ä¸ªå®šé•¿çš„å¥å­è¡¨ç¤ºå‘é‡ã€‚
- **ç›¸ä¼¼åº¦åˆ¤å®š**ï¼šä¸¤å¥ç»æ±‡èšåŽçš„å‘é‡ä½äºŽåŒä¸€æ•°å€¼ç©ºé—´ï¼Œç›´æŽ¥ä½¿ç”¨ `F.cosine_similarity` ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰è®¡ç®—å®ƒä»¬çš„è·ç¦»ã€‚

### 3. è®­ç»ƒä¸Žåé¦ˆ
- ç›¸ä¼¼/ä¸ç›¸ä¼¼æ ‡ç­¾ä»Ž `[0, 1]` è¢«çº¿æ€§æ˜ å°„åˆ° `[-1, 1]` åŒºé—´ï¼Œä¸Žè‡ªç„¶è½åœ¨ `[-1, 1]` èŒƒå›´çš„ä½™å¼¦ç›¸ä¼¼åº¦è¿›è¡Œå¯¹é½ï¼Œæœ€åŽç›´æŽ¥è®¡ç®—å‡æ–¹å·®æŸå¤±ï¼ˆMSELossï¼‰ã€‚
- ç»“åˆ Streamlit ç‹¬æœ‰çš„ä¸€ç‚¹ï¼šé€šè¿‡ Callback å°†æ¯ä¸€ä¸ª Batch çš„å®žæ—¶ Loss ä¸Šä¼ è‡³ `st.session_state`ï¼Œèƒ½å¤Ÿ**åŠ¨æ€å‘ˆçŽ°äºŽå‰ç«¯æŠ˜çº¿å›¾ä¸Š**ï¼Œå¢žå¼ºäº†å­¦ä¹ ä¸Žäº’åŠ¨çš„ä¹è¶£ã€‚

### 4. ç¡¬ä»¶åŠ é€Ÿ (GPU Support)
- æ¨¡åž‹åº•å±‚å·²åœ¨ `train.py` å’Œ `app.py` ä¸­å¢žåŠ äº†å¯¹å¼‚æž„è®¡ç®—è®¾å¤‡ï¼ˆå¦‚ NVIDIA CUDA æˆ– Apple Silicon MPSï¼‰çš„è‡ªåŠ¨è¯†åˆ«ä¸ŽæŽ¥ç®¡ã€‚å¦‚æžœæ£€æµ‹åˆ°å¯ç”¨ç¡¬ä»¶åŠ é€Ÿå™¨ï¼Œæ¨¡åž‹åŠè¿ç®—å¼ é‡ä¼šè‡ªåŠ¨è½½å…¥è®¾å¤‡ä»Žè€ŒèŽ·å¾—æžå¤§çš„è®­ç»ƒé€Ÿåº¦å¢žç›Šã€‚

### 5. æ¨¡åž‹æŒä¹…åŒ– (Model Persistence)
- å¢žåŠ äº†åœ¨å†…å­˜ä¸­æŠŠçŽ©åŽ**è½ç›˜**çš„èƒ½åŠ›ã€‚è®­ç»ƒå‡ºæ»¡æ„çš„æ›²çº¿åŽï¼Œç‚¹å‡»ä¾§è¾¹æ çš„â€œðŸ’¾ ä¿å­˜æ¨¡åž‹åˆ°æœ¬åœ°â€ï¼Œå®ƒä¼šå°† PyTorch æ¨¡åž‹æƒé‡å¼ é‡ (`model_weights.pth`) å’Œè‡ªå®šä¹‰åˆ†è¯è¡¨å­—å…¸ (`tokenizer.pkl`) åˆ†ç¦»ä¸”å®‰å…¨åœ°ä»¥äºŒè¿›åˆ¶å½¢å¼å­˜å…¥å·¥ä½œç›®å½•çš„ `output/` æ–‡ä»¶å¤¹ä¸‹ã€‚

### 6. æ¨¡åž‹é‡åŒ–è¯„ä¼°ä½“ç³» (Evaluation Metrics)
ä¸ºäº†ç›´è§‚å±•çŽ°æ¨¡åž‹ç©¶ç«Ÿæ˜¯ä¸æ˜¯åœ¨æ­»è®°ç¡¬èƒŒæˆ–æ˜¯çœŸçš„â€œæ˜Žç™½â€äº†å¥å­å«ä¹‰ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸¤ç§æžå…¶æ ¸å¿ƒçš„åˆ¤åˆ‘æŒ‡æ ‡å¹¶äºˆä»¥å›¾å½¢åŒ–ï¼š
- **å®žæ—¶ Accuracyï¼ˆæ‰¹æ¬¡å‡†ç¡®çŽ‡ï¼‰æ›²çº¿**ï¼šå’ŒæŸå¤±å‡½æ•° Loss å¹³è¡Œå‘ˆçŽ°ã€‚æˆ‘ä»¬é‡‡ç”¨å¼ºåˆ¤åˆ«æ³•åˆ™ï¼šé¢„æµ‹ç»“æžœ > 0 ä¸”çœŸå®ž Label ä¸ºç›¸ä¼¼ï¼Œæˆ– < 0 ä¸” Label ä¸ç›¸ä¼¼ï¼Œå³å¾— 1 åˆ†ã€‚è¿™ä½¿å¾—ä½ çœ‹åˆ°çš„ä¸åªæ˜¯è™šæ— ç¼¥ç¼ˆçš„è¯¯å·®æ•°å­—ï¼Œè¿˜æœ‰å®žæ‰“å®žåœ°â€œè¿™æ‰¹æ•°æ®åšå¯¹äº†ç™¾åˆ†ä¹‹å¤šå°‘â€ã€‚
- **Similarity Distribution (åˆ†å¸ƒç›´æ–¹äºŒç»´å›¾)**ï¼šä½¿ç”¨ `matplotlib` åœ¨ç•Œé¢æœ«å°¾ç”Ÿæˆçš„çº¢ç»¿è¦†ç›–ç›´æ–¹å›¾ã€‚ç»¿è‰²æŸ±å­ä»£è¡¨æ ‡ä¸ºâ€œç›¸ä¼¼â€çš„æ‰€æœ‰é¢„æµ‹æ‰“åˆ†ï¼ˆé›†ä¸­åå‘1ï¼‰ï¼›çº¢è‰²ä»£è¡¨â€œä¸ç›¸ä¼¼â€çš„æ‰“åˆ†ï¼ˆé›†ä¸­åå‘-1ï¼‰ã€‚æ¨¡åž‹è¶Šä¼˜ç§€ï¼Œè¿™çº¢ç»¿ä¸¤è‚¡å±±å³°åº”è¯¥å‘ˆçŽ°éžå¸¸å®Œç¾Žçš„**ä¸¤æžåˆ†åŒ–ä¸”æ— é‡å **çŠ¶æ€ã€‚ç›´è§‚è¯æ˜Žäº†è·ç¦»çš„æŽ¨å¼€ã€‚

### 7. CNN åŒå¡”æž¶æž„ (CNN Dual Encoder)
ä¸ºäº†å¯¹æ¯”ç ”ç©¶ï¼Œæˆ‘ä»¬åœ¨ä¿ç•™æžç®€ MeanPooling åŒå¡”çš„åŸºç¡€ä¸Šï¼Œæ–°å¢žäº†ä¸€ä¸ªåŸºäºŽä¸€ç»´å·ç§¯ç¥žç»ç½‘ç»œçš„åŒå¡”ï¼š
- **è¾“å…¥å±‚**ï¼šå¤ç”¨ç›¸åŒçš„ `nn.Embedding` å­—å‘é‡æŸ¥æ‰¾è¡¨ã€‚
- **å·ç§¯å±‚**ï¼šåŒæ—¶ä½¿ç”¨ä¸‰ä¸ªä¸åŒå°ºå¯¸çš„å·ç§¯æ ¸ (kernel_size=2, 3, 4) å¹¶è¡Œåœ°æ‰«æå­—å‘é‡åºåˆ—ï¼Œåˆ†åˆ«æ•æ‰ 2-gramã€3-gram å’Œ 4-gram çš„å±€éƒ¨ç»„åˆç‰¹å¾ï¼ˆæ¯”å¦‚â€œè‹¹æžœâ€ã€â€œæ‰“ç¯®çƒâ€è¿™ç±»å›ºå®šæ­é…ï¼‰ã€‚
- **ä¼˜åŒ–ä¸Žå¢žå¼º**ï¼šçº¯ç²¹çš„ CNN å®¹æ˜“è¿‡æ‹Ÿåˆä¸”åœ¨è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦æ—¶é­é‡é«˜ç»´ç¾éš¾ã€‚å› æ­¤æˆ‘ä»¬åŠ å…¥äº† `BatchNorm1d` ç¨³å®šæ¢¯åº¦ï¼Œ`Dropout(0.3)` åŠ  30% éšæœºå¤±æ´»é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œä»¥åŠåŸºäºŽ `Linear` çš„æŠ•å½±å±‚å°†æ‹¼æŽ¥åŽçš„ 192 ç»´ç‰¹å¾åŽ‹ç¼©å›ž 128 ç»´ã€‚
- **è¯çº§åˆ†è¯åŒ¹é…**ï¼šCNN å¿…é¡»é…åˆåŸºäºŽ `jieba` çš„è¯çº§åˆ†è¯å™¨ (`SimpleWordTokenizer`) æ‰èƒ½å‘æŒ¥å‡ºæ•èŽ· N-gram è¯æ„ç»„åˆçš„å¨åŠ›ï¼Œå¦åˆ™åœ¨å•å­—åˆ†è¯ä¸‹æ•ˆæžœç”šè‡³ä¸å¦‚ MeanPoolingã€‚

### 8. å¤§æ•°æ®æ”¯æ’‘ä¸Ž UI æ€§èƒ½ä¼˜åŒ– (Performance & Scaling)
å½“æˆ‘ä»¬å°†è®­ç»ƒè¯­æ–™ä»Ž 60 æ¡ (`lcqmc_mini.csv`) çŒ›å¢žè‡³ 20,000 æ¡ (`lcqmc_2w.csv`) æ—¶ï¼Œæžç®€æž¶æž„æˆåŠŸé¡¶ä½äº†åŽ‹åŠ›ï¼Œä½†äº¤äº’ç«¯é¢ä¸´äº†å·¨å¤§æŒ‘æˆ˜ã€‚æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹æ‰‹æ®µå®žçŽ°äº†ç§’çº§å“åº”ï¼š
- **Streamlit æ¸²æŸ“èŠ‚æµ**ï¼šæ”¾å¼ƒæ¯ batch åˆ·æ–°å›¾è¡¨çš„æ–¹æ¡ˆï¼Œæ”¹ä¸ºæ¯ 50 æ­¥æˆ–æ¯ Epoch ç»“æŸæ—¶æ‰å‘æµè§ˆå™¨æŽ¨é€å›¾è¡¨æ›´æ–°ï¼Œå½»åº•é¿å…äº† WebSocket è¿‡è½½æ–­è¿žé—®é¢˜ã€‚
- **æ•°æ®ä¸Žç»„ä»¶ç¼“å­˜**ï¼šåˆ©ç”¨ `@st.cache_resource` ç¼“å­˜ PyTorch æ¨¡åž‹çš„å®žä¾‹åŒ–ä¸ŽåŠ è½½ï¼Œå¹¶ç”¨ `@st.cache_data` ç¼“å­˜ PCA é™ç»´ç»“æžœï¼Œé˜²æ­¢é¡µé¢åˆ‡æ¢æ—¶è§¦å‘æžå…¶æ˜‚è´µçš„é‡ç»˜ã€‚
- **GPU æ‰¹é‡æŽ¨ç†åŠ é€Ÿ**ï¼šç›´æ–¹å›¾æ‰€éœ€çš„ä¸¤ä¸‡æ¡æ•°æ®çš„å…¨å±€æ£€éªŒï¼Œä»ŽåŽŸå…ˆ `df.iterrows()` é€è¡Œä½Žæ•ˆæŽ¨ç†ä¿®æ”¹ä¸ºäº†åŸºäºŽ `batch_size=256` çš„ DataLoader å¼å¼ é‡æ‰¹å¤„ç†ï¼Œé…åˆ `torch.no_grad()` å°†å…¨é‡æ£€éªŒæ—¶é—´ä»Žå‡ åˆ†é’Ÿç¼©çŸ­è‡³ 1 ç§’ä»¥å†…ã€‚è¿™ä¸ä»…å¸¦æ¥äº†æžé€Ÿä½“éªŒï¼Œæ›´ä¸€ä¸¾ä¿®å¤äº†ç”±æ­¤é˜»å¡žé€ æˆçš„â€œç›¸ä¼¼åº¦è®¡ç®—æŒ‰é’®ç‚¹å‡»æ— ååº”â€æ¶æ€§ Bugã€‚

## ðŸª„ ç»„ä»¶è¯´æ˜Ž
æœ¬æ¬¡æ ¸å¿ƒæž„å»ºå¼•å…¥äº†ä»¥ä¸‹åˆ†ç¦»çš„æ¨¡å—ç»“æž„ï¼š
- `data.py` - è½»é‡çº§æ–‡æœ¬è¯»å–ä¸Žæ‰¹å¤„ç†é¢„å¤‡é˜Ÿï¼›
- `model.py` - æœ€è£¸éœ²çº¯ç²¹çš„æ•°å­¦è®¡ç®—æ˜ å°„æ¨¡åž‹ï¼›
- `train.py` - æ¨¡åž‹è®­ç»ƒå·¥åŽ‚ä¸Žä¼˜åŒ–å¾ªçŽ¯å°è£…ï¼›
- `app.py` - å…¨å±€è°ƒåº¦æŒ‡æŒ¥ä¸Ž Streamlit äº¤äº’å‘ˆçŽ°é—¨æˆ·ã€‚

## ðŸš€ å¦‚ä½•ä½¿ç”¨
è¯¥é¡¹ç›®æä¾›äº†æ”¯æŒ 20,000 æ¡æ•°æ®é›†å¼€ç®±å³ç”¨çš„ Web Appï¼š
1. ç¡®ä¿å·²åœ¨çŽ¯å¢ƒä¸­å®‰è£…ä¾èµ–ï¼š`pip install -r requirements.txt` (å°¤å…¶æ˜¯åŠ å…¥äº†ç”¨äºŽ CNN çš„ `jieba` åˆ†è¯)ã€‚
2. å¯åŠ¨å›¾å½¢åŒ–æœåŠ¡ï¼šç»ˆç«¯æ‰§è¡Œ `streamlit run app.py`ã€‚
3. æµè§ˆå™¨ä¼šè‡ªåŠ¨è·³è‡³ `http://localhost:8501`ï¼š
   - **æ­¥éª¤ 1**ï¼šåœ¨ä¾§è¾¹æ æŒ‰ä¸‹ã€ðŸš€ å¼€å§‹è®­ç»ƒã€‘ï¼Œæ²‰æµ¸å¼è§‚å¯Ÿ Loss å‡½æ•°çš„ä¸‹å¡è¿åŠ¨ã€‚
   - **æ­¥éª¤ 2**ï¼šåœ¨ä¸»æŽ§ Tab çš„ã€ç©ºé—´ç‰¹å¾é™ç»´ã€‘é¡µé¢è§‚å¯Ÿå…·æœ‰ç›¸è¿‘è¯­ä¹‰çš„å¥å­/è¯æ±‡åœ¨ç»è¿‡ PCA ä¸»æˆåˆ†åˆ†æžåŽåœ¨å¹³é¢ä¸Šçš„é›†ç¾¤è½ç‚¹ã€‚
   - **æ­¥éª¤ 3**ï¼šåˆ‡æ¢è‡³æœ€ç»ˆçš„ã€æ¨¡åž‹é¢„æµ‹ã€‘é¡µé¢ï¼Œå·¦å³æ‰‹äº’æï¼Œéšæ„è¾“å…¥å¥å­æ£€éªŒå¾®åž‹åŒå¡”æ¨¡åž‹å¯¹è‡ªç„¶è¯­è¨€çš„æœ´ç´ æ„ŸçŸ¥åŠ›ã€‚
